<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:camel="http://camel.apache.org/schema/spring"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

    <camel:camelContext id="emailServiceCamel" errorHandlerRef="emailErrorHandler">
        <camel:errorHandler id="emailErrorHandler" deadLetterUri="jms:queue:${email.service.errors.queue}"
                            type="DeadLetterChannel" useOriginalMessage="true"/>

        <camel:errorHandler id="smtpHandler" deadLetterUri="jms:queue:${email.service.retry.queue}"
                            type="DeadLetterChannel" useOriginalMessage="true">
            <camel:redeliveryPolicy maximumRedeliveries="${email.service.max.redeliveries}"
                                    useExponentialBackOff="${email.service.use.exponential.back.off}"/>
        </camel:errorHandler>

        <camel:endpoint id="emailIn" uri="jms:queue:${email.service.in.queue}"/>
        <camel:endpoint id="DLQ" uri="jms:queue:${email.service.errors.queue}"/>
        <camel:endpoint id="failureUri" uri="direct:errors"/>
        <camel:endpoint id="retryQueue" uri="jms:queue:${email.service.retry.queue}"/>
        <camel:endpoint id="retryUri" uri="direct:retry"/>

        <camel:dataFormats>
            <camel:xstream id="xstream-default"/>
        </camel:dataFormats>

        <camel:onException>
            <camel:exception>org.burgers.email.service.TemplateProcessingException</camel:exception>
            <camel:handled>
                <camel:constant>true</camel:constant>
            </camel:handled>
            <camel:to ref="failureUri"/>
        </camel:onException>

        <camel:onException>
            <camel:exception>org.springframework.mail.MailSendException</camel:exception>
            <camel:handled>
                <camel:constant>true</camel:constant>
            </camel:handled>
            <camel:to ref="retryUri"/>
        </camel:onException>

        <camel:route id="emailProcessing" errorHandlerRef="emailErrorHandler">
            <camel:from ref="emailIn"/>

            <camel:unmarshal ref="xstream-default"/>
            <camel:bean ref="emailSender" method="sendMessage"/>
        </camel:route>

        <camel:route id="failureRoute">
            <camel:from ref="failureUri"/>
            <camel:to ref="DLQ"/>
        </camel:route>

        <camel:route id="retryRoute">
            <camel:from ref="retryUri"/>
            <camel:to ref="retryQueue"/>
        </camel:route>

    </camel:camelContext>

</beans>